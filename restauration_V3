#!/bin/bash
##################################################################################################
##											 	##
##												##
##					SCRIPT RESTAURATION					##
##												##
##												##
##################################################################################################
##Auteur: Laurent NERO						       				##
##Version: 1											##
##################################################################################################
##					DESCRIPTION						##
##################################################################################################
#Ce script a pour but la sauvegarde incrementale de tout les fichiers n√©ccessaires √†             #
#une restauration de donn√©es d'un site WordPress  en cas de disfonctionnement du disque	dur	 #
#Les actions du script sont les suivantes:						         #
#-Cr√©ation d'un dossier compr√©ss√© des fichiers sp√©cifi√©						 #
#-Transfert du dossier compr√©ss√© vers le sereur de sauvegarde  					 #
#-R√É¬©seau sur lequel se trouve  les postes de travail.						 #
#-Possibilit√É¬© de supprimer l'utilisateur admin.  						 #
##################################################################################################

# PARAMETRES A EDITER
#######################
SERVER="192.168.10.14"               #Serveur backup FTP
 USER="admin"                   #Votre nom d'utilisateur
 PASS="0000"                    #Votre password

 #### Informations Base de donn√©e ####
SITE_PATH="/var/www/html" #Could also be subsites/subsitename

##V√©rification de l'acc√®s au serveur de sauvegarde

#ftp -i -n $SERVER << END_SCRIPT
#quote USER $USER
#quote PASS $PASS
#END_SCRIPT

###Restauration adresse IP ancien serveur



##V√©rification de la derni√®re sauvegarde pr√©sente
hier=$(date -d "1 day ago" '+%d-%m-%Y')
jour=$(date +"%d-%m-%Y")
last_backup_WP=backup_WP.$hier 
backup_WP=backup_WP.$jour

#D√©claratation variables couleur texte commandes echo
neutre='\e[0;m' 
rouge='\e[0;31m' 
vert='\e[0;32m' 

echo "#################################RESTAURATION DE SAUVEGARDE###################################"

echo     Quelle est la sauvegarde ‡ restaurer?
echo -e  "${neutre}Sauvegarde du jour     ${vert}Tapez 1${neutre}"
echo -e  "${neutre}Sauvegarde de la veille  ${vert}Tapez 2${neutre}"

 read choix
 if [ $choix = "1" ]; then
 jour=$(date +"%d-%m-%Y")
 backup_WP=backup_WP.$jour
 date_backup=$jour

echo $backup_WP
 elif [ $choix = "2" ]; then
 hier=$(date -d "1 day ago" '+%d-%m-%Y')
 backup_WP=backup_WP.$hier
 date_backup=$hier

 fi

##Transfert de la derni√®re sauvegarde
echo -e  "${vert}RÈcupÈration de la sauvegarde du jour ${neutre}"
ftp -i -n $SERVER << END_SCRIPT
quote USER $USER
quote PASS $PASS
pwd
bin
cd $backup_WP
mget *
prompt
quit
END_SCRIPT


##D√©placement des donn√©es vers le fichier racine du site web aprËs suppression ancien fichier 

##D√©compression de la sauvegarde:
rm -r /var/www/html/* #Suppression de la racine du site Web vierge
cd /var/www/html && tar -xvf /root/html.$date_backup.tar.gz 2>>/var/log/restauration_error.log  #DÈcompression de la sauvegarde dans le dossier racine 


##Restauration de la base de donn√©e
mysql -u dbadminwp -pOcp6@wordpress -D db_wp < /root/db_wp.$date_backup.sql 2>>/var/log/restauration_error.log

